<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كشوف الناخبين - لجنة 26 - مدرسة الأحمدية</title>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
    <style>
        body {font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:20px;}
        .container {max-width:1000px; margin:auto; background:white; padding:25px; border-radius:15px; box-shadow:0 6px 20px rgba(0,0,0,0.1);}
        h1 {text-align:center; margin-bottom:5px; color:#1877f2;}
        .subtitle {text-align:center; color:#444; margin-bottom:20px; font-size:18px;}

        .upload-area {border:3px dashed #1877f2; padding:30px; text-align:center; border-radius:15px; background:#f8f9fa; margin-top:20px;}
        textarea {width:100%; height:260px; padding:12px; font-size:16px; border-radius:8px; border:2px solid #ccc;}

        .search-box {width:100%; padding:16px; font-size:22px; border-radius:50px;
            border:3px solid #1877f2; margin:20px 0; text-align:center;}

        .results {margin-top:20px; max-height:500px; overflow-y:auto;}

        .voter-item {
            background:#fff; padding:15px; border-right:6px solid #28a745; border-radius:12px;
            margin:10px 0; cursor:pointer; transition:.25s; box-shadow:0 3px 10px rgba(0,0,0,0.08);
        }
        .voter-item:hover {background:#e8f5e8; transform:translateX(-6px);}

        .voter-name {font-size:20px; font-weight:bold;}
        .voter-serial {font-size:24px; font-weight:bold; color:#d32f2f;}

        /* منطقة الكاميرا */
        .camera-section {margin:20px 0; text-align:center;}
        #videoPreview {width:100%; max-width:640px; border:3px solid #1877f2; border-radius:12px; display:none;}
        #canvasOCR {display:none;}
        .camera-controls {margin:15px 0;}
        .camera-controls button {padding:12px 25px; margin:5px; border-radius:8px; border:none; color:white; font-size:16px; cursor:pointer;}
        .btn-start {background:#4caf50;}
        .btn-stop {background:#f44336;}
        .ocr-status {margin:10px 0; padding:10px; background:#fff3cd; border-radius:8px; border:2px solid #ffc107; font-weight:bold;}

        /* البطاقة العائمة */
        .modal {display:none; position:fixed; left:0; top:0; width:100%; height:100%;
            background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center;}

        .card {width:380px; background:white; border-radius:18px; overflow:hidden;
            box-shadow:0 10px 30px rgba(0,0,0,0.5);}

        .card-header {background:#0d47a1; color:white; padding:18px; text-align:center;
            font-size:26px; font-weight:bold;}

        .voter-fullname {background:#e3f2fd; padding:20px; margin:15px;
            border-right:6px solid #1976d2; font-size:22px; font-weight:bold;}

        .big-serial {
            margin: 10px 15px;
            font-size: 32px;
            font-weight: 900;
            color: #c62828;
            text-align:center;
            border-right:6px solid #d32f2f;
            background:#ffebee;
            padding:15px;
            border-radius:12px;
        }

        .committee-box {background:#e8eaf6; padding:18px; margin:15px;
            border-right:6px solid #3f51b5; font-size:26px; font-weight:bold;}

        .place-box {background:#e8f5e9; padding:18px; margin:15px;
            border-right:6px solid #4caf50; font-size:22px;}

        .print-btn {background:#d32f2f; color:white; border:none; width:80%; padding:14px;
            margin:20px auto; border-radius:40px; font-size:22px; cursor:pointer;}

        /* الطباعة بحجم 5×2.5 سم */
        @media print {
            body * {visibility:hidden;}
            #printArea, #printArea * {visibility:visible;}
            #printArea {
                position:absolute;
                left:0;
                top:0;
                width:5cm;
                height:2.5cm;
                background:white;
                padding-top:0.6cm;
                text-align:center;
                border:1px solid #000;
            }
            @page {
                size: 5cm 2.5cm;
                margin:0;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <h1>لجنة 26</h1>
    <p class="subtitle">الصق النص الخام من PDF أو Word — النظام يستخرج كل ناخب تلقائيًا</p>

    <div class="upload-area">
        <p>الصق النص هنا كما هو من PDF أو Word</p>
        <textarea id="textInput" placeholder="مثال: ١ ابتسام ... ٢ ابتسام ... ٣ ... في نفس السطر أو سطور متعددة"></textarea>
        <button onclick="loadData()" style="margin-top:10px; padding:12px 30px; background:#1877f2; color:white; border:none; border-radius:8px; cursor:pointer;">
            تحميل البيانات
        </button>
    </div>

    <!-- قسم الكاميرا المباشرة -->
    <div class="camera-section">
        <div class="camera-controls">
            <button class="btn-start" onclick="startCamera()">تشغيل الكاميرا والسكان الفوري</button>
            <button class="btn-stop" onclick="stopCamera()">إيقاف الكاميرا</button>
        </div>
        <div id="ocrStatus" class="ocr-status" style="display:none;">
            جاري السكان المباشر... ضع البطاقة أمام الكاميرا
        </div>
        <video id="videoPreview" autoplay playsinline></video>
        <canvas id="canvasOCR"></canvas>
    </div>

    <input type="text" id="searchBox" class="search-box" placeholder="ابحث بالاسم أو الرقم..." onkeyup="search()">

    <div id="results" class="results"></div>
</div>

<!-- البطاقة -->
<div id="modal" class="modal" onclick="this.style.display='none'">
    <div class="card" onclick="event.stopPropagation()">
        <div class="card-header">بطاقة الناخب</div>

        <div class="voter-fullname" id="mName"></div>

        <div class="big-serial" id="mSerial"></div>

        <div class="committee-box">رقم اللجنة: 26</div>
        <div class="place-box">مدرسة الأحمدية</div>

        <button class="print-btn" onclick="printCard()">طباعة</button>
    </div>
</div>

<!-- جزء الطباعة فقط -->
<div id="printArea" style="display:none;">
    <div id="pSerialOnly" style="
        font-size:28px;
        font-weight:bold;
        text-align:center;
        margin-top:4px;
    "></div>
</div>

<script>
let voters = [];
let videoStream = null;
let isScanning = false;
let ocrWorker = null;
let scanInterval = null;

// تحويل الأرقام العربية للهندية
function fixNumbers(str) {
    const map = {"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};
    return str.replace(/[٠-٩]/g, d => map[d]);
}

// استخراج كل (رقم + اسم) من السطر الواحد
function extractNumberName(line) {
    line = fixNumbers(line).trim();
    if (!line) return [];

    if (line.includes("مسلسل السم")) return [];
    if (/^\d+\s+من\s+\d+/.test(line)) return [];
    if (line.includes("رقم اللجنة")) return [];

    let regex = /(\d{1,5})\s+([\u0600-\u06FF]+(?:\s+[\u0600-\u06FF]+)*)(?=\s+\d{1,5}\b|$)/g;
    let matches = [...line.matchAll(regex)];
    if (!matches.length) return [];

    return matches.map(m => ({
        number: m[1],
        name: m[2].trim()
    }));
}

// تحميل النص كامل
function loadData() {
    const text = document.getElementById("textInput").value.trim();
    if (!text) { alert("أدخل النص أولاً!"); return; }

    voters = [];
    const lines = text.split(/\n/);

    lines.forEach(line => {
        const recs = extractNumberName(line);
        if (recs.length) voters.push(...recs);
    });

    alert("تم تحميل " + voters.length + " ناخب.");
    search();
}

// البحث وعرض النتائج
function search() {
    let q = document.getElementById("searchBox").value.trim();
    let res = document.getElementById("results");
    res.innerHTML = "";

    const matched = voters.filter(v =>
        v.name.includes(q) || v.number.includes(q)
    );

    matched.forEach(v => {
        const div = document.createElement("div");
        div.className = "voter-item";
        div.innerHTML = `
            <div class="voter-name">${v.name}</div>
            <div class="voter-serial">رقم الكشف: ${v.number}</div>
        `;
        div.onclick = () => showCard(v);
        res.appendChild(div);
    });
}

// فتح البطاقة العائمة
function showCard(v) {
    document.getElementById("mName").textContent = v.name;
    document.getElementById("mSerial").textContent = "رقم الكشف: " + v.number;

    document.getElementById("pSerialOnly").textContent = v.number;

    document.getElementById("modal").style.display = "flex";
}

// الطباعة
function printCard() {
    window.print();
}

// استخراج الرقم القومي والاسم من نص البطاقة
function extractIDInfo(text) {
    let idMatch = text.match(/(?:[12][0-9]{9}[0-9]{4})/);
    let name = "";
    let nameMatch = text.match(/الاسم[:\s]*([^\n\r]+)\n?/);
    if (nameMatch && nameMatch[1].length > 7) name = nameMatch[1].trim();
    if (!name && idMatch) {
        let i = text.indexOf(idMatch[0]);
        if (i > 0) {
            let beforeID = text.slice(0, i).split('\n');
            if (beforeID.length) name = beforeID[beforeID.length - 1].replace(/[^ \u0621-\u064a]/g, '').trim();
        }
    }
    return {id: idMatch ? idMatch[0] : "", name};
}

// تشغيل الكاميرا والسكان الفوري
async function startCamera() {
    try {
        const video = document.getElementById('videoPreview');
        const canvas = document.getElementById('canvasOCR');
        const status = document.getElementById('ocrStatus');
        
        // إيقاف أي كاميرا سابقة
        if (videoStream) {
            stopCamera();
        }

        // طلب الوصول للكاميرا الخلفية
        videoStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } },
            audio: false
        });

        video.srcObject = videoStream;
        video.style.display = 'block';
        status.style.display = 'block';
        
        // تهيئة Tesseract Worker
        if (!ocrWorker) {
            ocrWorker = await Tesseract.createWorker('ara');
        }

        isScanning = true;

        // بدء السكان المستمر كل 2 ثانية
        scanInterval = setInterval(async () => {
            if (!isScanning) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // التقاط إطار من الفيديو
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            try {
                // تنفيذ OCR على الإطار
                const { data: { text } } = await ocrWorker.recognize(canvas);
                
                if (text && text.trim().length > 10) {
                    let info = extractIDInfo(text);
                    
                    if (info.name || info.id) {
                        let searchTerm = info.name ? info.name : info.id;
                        document.getElementById('searchBox').value = searchTerm;
                        search();
                        
                        // عرض إشعار بالنتيجة
                        status.innerHTML = `✓ تم العثور على: ${info.name || 'غير واضح'}<br>الرقم القومي: ${info.id || 'غير واضح'}`;
                        status.style.background = '#d4edda';
                        status.style.borderColor = '#28a745';
                    }
                }
            } catch (err) {
                console.error('خطأ في OCR:', err);
            }
        }, 2000); // سكان كل ثانيتين

    } catch (error) {
        alert("فشل الوصول للكاميرا. تأكد من السماح للمتصفح باستخدام الكاميرا.");
        console.error(error);
    }
}

// إيقاف الكاميرا
function stopCamera() {
    isScanning = false;
    
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    
    const video = document.getElementById('videoPreview');
    const status = document.getElementById('ocrStatus');
    
    video.style.display = 'none';
    status.style.display = 'none';
    video.srcObject = null;
}

// تنظيف عند إغلاق الصفحة
window.addEventListener('beforeunload', () => {
    stopCamera();
    if (ocrWorker) {
        ocrWorker.terminate();
    }
});
</script>

</body>
</html>
